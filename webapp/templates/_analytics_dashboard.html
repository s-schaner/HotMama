<!-- Analytics Dashboard Component -->
<div class="analytics-dashboard" x-data="analyticsDashboard()">
    <!-- Dashboard Header -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Player Analytics Dashboard</h2>
        <div class="flex gap-2">
            <button @click="refreshStats()" class="btn btn-sm btn-primary">
                <span>Refresh Stats</span>
            </button>
            <button @click="exportStats()" class="btn btn-sm btn-outline">
                <span>Export CSV</span>
            </button>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="card bg-base-200 p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Team Filter -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Team</span>
                </label>
                <select x-model="filters.team" @change="filterStats()" class="select select-bordered select-sm">
                    <option value="">All Teams</option>
                    <option value="A">Team A</option>
                    <option value="B">Team B</option>
                </select>
            </div>

            <!-- Player Filter -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Player Number</span>
                </label>
                <input x-model="filters.playerNumber" @input="filterStats()"
                       type="text" placeholder="Filter by number"
                       class="input input-bordered input-sm">
            </div>

            <!-- Stat Category -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Stat Category</span>
                </label>
                <select x-model="filters.category" @change="filterStats()" class="select select-bordered select-sm">
                    <option value="all">All Stats</option>
                    <option value="offensive">Offensive</option>
                    <option value="defensive">Defensive</option>
                    <option value="errors">Errors</option>
                </select>
            </div>

            <!-- Sort By -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Sort By</span>
                </label>
                <select x-model="filters.sortBy" @change="sortStats()" class="select select-bordered select-sm">
                    <option value="rating">Overall Rating</option>
                    <option value="kills">Kills</option>
                    <option value="digs">Digs</option>
                    <option value="blocks">Blocks</option>
                    <option value="assists">Assists</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Summary Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="stat bg-base-200 rounded-lg shadow">
            <div class="stat-title">Total Players Tracked</div>
            <div class="stat-value text-primary" x-text="summary.totalPlayers">0</div>
            <div class="stat-desc">Across all teams</div>
        </div>

        <div class="stat bg-base-200 rounded-lg shadow">
            <div class="stat-title">Total Events</div>
            <div class="stat-value text-secondary" x-text="summary.totalEvents">0</div>
            <div class="stat-desc">All event types</div>
        </div>

        <div class="stat bg-base-200 rounded-lg shadow">
            <div class="stat-title">Avg Attack Efficiency</div>
            <div class="stat-value text-accent" x-text="summary.avgAttackEff.toFixed(3)">0.000</div>
            <div class="stat-desc">Team average</div>
        </div>

        <div class="stat bg-base-200 rounded-lg shadow">
            <div class="stat-title">Avg Dig Percentage</div>
            <div class="stat-value text-info" x-text="summary.avgDigPct.toFixed(1) + '%'">0%</div>
            <div class="stat-desc">Team average</div>
        </div>
    </div>

    <!-- Player Stats Table -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h3 class="card-title">Player Statistics</h3>

            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>Track ID</th>
                            <th>Team</th>
                            <th>Number</th>
                            <th>Kills</th>
                            <th>Attacks</th>
                            <th>Attack Eff</th>
                            <th>Digs</th>
                            <th>Blocks</th>
                            <th>Assists</th>
                            <th>Serve Aces</th>
                            <th>Errors</th>
                            <th>Rating</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="player in filteredPlayers" :key="player.track_id">
                            <tr>
                                <td><span class="badge badge-sm" x-text="player.track_id"></span></td>
                                <td><span class="badge badge-primary" x-text="player.team"></span></td>
                                <td><strong x-text="player.number"></strong></td>
                                <td x-text="player.kills || 0"></td>
                                <td x-text="player.attacks || 0"></td>
                                <td>
                                    <span class="badge"
                                          :class="player.attack_efficiency >= 0.3 ? 'badge-success' :
                                                  player.attack_efficiency >= 0.1 ? 'badge-warning' : 'badge-error'"
                                          x-text="(player.attack_efficiency || 0).toFixed(3)">
                                    </span>
                                </td>
                                <td x-text="player.digs || 0"></td>
                                <td x-text="player.blocks || 0"></td>
                                <td x-text="player.assists || 0"></td>
                                <td x-text="player.serve_aces || 0"></td>
                                <td>
                                    <span class="badge badge-error"
                                          x-text="(player.attack_errors || 0) + (player.serve_errors || 0)">
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-lg"
                                          :class="player.rating >= 50 ? 'badge-success' :
                                                  player.rating >= 20 ? 'badge-info' : 'badge-neutral'"
                                          x-text="(player.rating || 0).toFixed(1)">
                                    </span>
                                </td>
                                <td>
                                    <button @click="viewPlayerDetail(player)" class="btn btn-xs btn-ghost">
                                        Details
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <template x-if="filteredPlayers.length === 0">
                            <tr>
                                <td colspan="13" class="text-center text-gray-500">
                                    No player data available
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Team Comparison -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <!-- Team A Stats -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title">Team A Summary</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Total Kills:</span>
                        <strong x-text="teamStats.A.kills || 0">0</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Digs:</span>
                        <strong x-text="teamStats.A.digs || 0">0</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Blocks:</span>
                        <strong x-text="teamStats.A.blocks || 0">0</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Assists:</span>
                        <strong x-text="teamStats.A.assists || 0">0</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Errors:</span>
                        <strong class="text-error" x-text="teamStats.A.errors || 0">0</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team B Stats -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title">Team B Summary</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Total Kills:</span>
                        <strong x-text="teamStats.B.kills || 0">0</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Digs:</span>
                        <strong x-text="teamStats.B.digs || 0">0</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Blocks:</span>
                        <strong x-text="teamStats.B.blocks || 0">0</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Assists:</span>
                        <strong x-text="teamStats.B.assists || 0">0</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Errors:</span>
                        <strong class="text-error" x-text="teamStats.B.errors || 0">0</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Detail Modal -->
    <div x-show="showPlayerDetail" class="modal" :class="showPlayerDetail && 'modal-open'">
        <div class="modal-box max-w-4xl">
            <h3 class="font-bold text-lg mb-4">
                Player Details - Track ID: <span x-text="selectedPlayer?.track_id"></span>
            </h3>

            <template x-if="selectedPlayer">
                <div>
                    <!-- Basic Info -->
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="stat bg-base-200 rounded">
                            <div class="stat-title">Team</div>
                            <div class="stat-value text-sm" x-text="selectedPlayer.team"></div>
                        </div>
                        <div class="stat bg-base-200 rounded">
                            <div class="stat-title">Number</div>
                            <div class="stat-value text-sm" x-text="selectedPlayer.number"></div>
                        </div>
                        <div class="stat bg-base-200 rounded">
                            <div class="stat-title">Overall Rating</div>
                            <div class="stat-value text-sm" x-text="selectedPlayer.rating?.toFixed(1)"></div>
                        </div>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="divider">Offensive Stats</div>
                    <div class="grid grid-cols-4 gap-2 mb-4 text-sm">
                        <div><strong>Kills:</strong> <span x-text="selectedPlayer.kills || 0"></span></div>
                        <div><strong>Attacks:</strong> <span x-text="selectedPlayer.attacks || 0"></span></div>
                        <div><strong>Attack Eff:</strong> <span x-text="selectedPlayer.attack_efficiency?.toFixed(3)"></span></div>
                        <div><strong>Assists:</strong> <span x-text="selectedPlayer.assists || 0"></span></div>
                    </div>

                    <div class="divider">Defensive Stats</div>
                    <div class="grid grid-cols-4 gap-2 mb-4 text-sm">
                        <div><strong>Digs:</strong> <span x-text="selectedPlayer.digs || 0"></span></div>
                        <div><strong>Dig %:</strong> <span x-text="selectedPlayer.dig_percentage?.toFixed(1) + '%'"></span></div>
                        <div><strong>Blocks:</strong> <span x-text="selectedPlayer.blocks || 0"></span></div>
                        <div><strong>Receives:</strong> <span x-text="selectedPlayer.receives || 0"></span></div>
                    </div>

                    <div class="divider">Serving Stats</div>
                    <div class="grid grid-cols-4 gap-2 mb-4 text-sm">
                        <div><strong>Serves:</strong> <span x-text="selectedPlayer.serves || 0"></span></div>
                        <div><strong>Aces:</strong> <span x-text="selectedPlayer.serve_aces || 0"></span></div>
                        <div><strong>Serve Eff:</strong> <span x-text="selectedPlayer.serve_efficiency?.toFixed(3)"></span></div>
                        <div><strong>Serve Errors:</strong> <span x-text="selectedPlayer.serve_errors || 0"></span></div>
                    </div>

                    <div class="divider">Errors</div>
                    <div class="grid grid-cols-4 gap-2 text-sm">
                        <div><strong>Attack Errors:</strong> <span class="text-error" x-text="selectedPlayer.attack_errors || 0"></span></div>
                        <div><strong>Serve Errors:</strong> <span class="text-error" x-text="selectedPlayer.serve_errors || 0"></span></div>
                        <div><strong>Dig Errors:</strong> <span class="text-error" x-text="selectedPlayer.dig_errors || 0"></span></div>
                        <div><strong>Block Errors:</strong> <span class="text-error" x-text="selectedPlayer.block_errors || 0"></span></div>
                    </div>
                </div>
            </template>

            <div class="modal-action">
                <button @click="showPlayerDetail = false" class="btn">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function analyticsDashboard() {
    return {
        players: [],
        filteredPlayers: [],
        selectedPlayer: null,
        showPlayerDetail: false,

        filters: {
            team: '',
            playerNumber: '',
            category: 'all',
            sortBy: 'rating'
        },

        summary: {
            totalPlayers: 0,
            totalEvents: 0,
            avgAttackEff: 0,
            avgDigPct: 0
        },

        teamStats: {
            A: {},
            B: {}
        },

        init() {
            this.loadStats();
        },

        async loadStats() {
            try {
                const response = await fetch('/_api/analytics/stats');
                if (response.ok) {
                    const data = await response.json();
                    this.players = data.players || [];
                    this.updateSummary();
                    this.updateTeamStats();
                    this.filterStats();
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        },

        async refreshStats() {
            await this.loadStats();
        },

        filterStats() {
            let filtered = [...this.players];

            // Team filter
            if (this.filters.team) {
                filtered = filtered.filter(p => p.team === this.filters.team);
            }

            // Player number filter
            if (this.filters.playerNumber) {
                filtered = filtered.filter(p =>
                    p.number?.toString().includes(this.filters.playerNumber)
                );
            }

            // Category filter
            if (this.filters.category !== 'all') {
                // Apply category-specific filtering if needed
            }

            this.filteredPlayers = filtered;
            this.sortStats();
        },

        sortStats() {
            const sortBy = this.filters.sortBy;
            this.filteredPlayers.sort((a, b) => {
                const valA = a[sortBy] || 0;
                const valB = b[sortBy] || 0;
                return valB - valA; // Descending order
            });
        },

        updateSummary() {
            this.summary.totalPlayers = this.players.length;
            this.summary.totalEvents = this.players.reduce((sum, p) => {
                return sum + (p.kills || 0) + (p.digs || 0) + (p.blocks || 0) + (p.assists || 0);
            }, 0);

            const avgAttackEff = this.players.reduce((sum, p) => sum + (p.attack_efficiency || 0), 0) / (this.players.length || 1);
            this.summary.avgAttackEff = avgAttackEff;

            const avgDigPct = this.players.reduce((sum, p) => sum + (p.dig_percentage || 0), 0) / (this.players.length || 1);
            this.summary.avgDigPct = avgDigPct;
        },

        updateTeamStats() {
            ['A', 'B'].forEach(team => {
                const teamPlayers = this.players.filter(p => p.team === team);
                this.teamStats[team] = {
                    kills: teamPlayers.reduce((sum, p) => sum + (p.kills || 0), 0),
                    digs: teamPlayers.reduce((sum, p) => sum + (p.digs || 0), 0),
                    blocks: teamPlayers.reduce((sum, p) => sum + (p.blocks || 0), 0),
                    assists: teamPlayers.reduce((sum, p) => sum + (p.assists || 0), 0),
                    errors: teamPlayers.reduce((sum, p) =>
                        sum + (p.attack_errors || 0) + (p.serve_errors || 0) + (p.dig_errors || 0) + (p.block_errors || 0), 0
                    )
                };
            });
        },

        viewPlayerDetail(player) {
            this.selectedPlayer = player;
            this.showPlayerDetail = true;
        },

        async exportStats() {
            try {
                const response = await fetch('/_api/analytics/export', {
                    method: 'POST'
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'player_stats_export.csv';
                    a.click();
                }
            } catch (error) {
                console.error('Failed to export stats:', error);
            }
        }
    };
}
</script>
